{% extends 'base.html' %}
{% block content %}

{# ===== Lista 24 pozycji z Excela (OPIS, AREA, SEQ) ===== #}
{% set default_area_seq = [
  ('STABILIZATOR','J01','C31251'), ('PODPORA','J02','C31152'),
  ('L.STAB','J03','C31252'),      ('PODPORA','J04','C31154'),
  ('L.STAB','J05','C31253'),      ('AMOR','J06','C31118'),
  ('AMOR','J07','C31221'),        ('AMOR','J08','C31121'),
  ('HEBEL','J09','C31124'),       ('PRZEWODY','J10','C32146'),
  ('WIĄZKI PA KRK','J11','C32212'),('AD BLUE','J12','C32524'),
  ('AD BLUE','J13','C32253'),     ('RURA','J14','C32260'),
  ('KOMIN','J15','C32370'),       ('BŁOTNIKI','J16','C32280'),
  ('INSTRUKCJE','J17','C33523'),  ('BELKA','J18','C31165'),
  ('PŁUG','J19','C32190'),        ('RAM','J20','C31301'),
  ('RAM','J21','C31302'),         ('FILTR','J22','C32096'),
  ('BLACHA','J23','C32047'),      ('FARTUCH','J24','C32045')
] %}

<!-- Cała tablica przewijana horyzontalnie na wąskich ekranach -->
<div class="lt-board-scroll">
  <div class="lt-board-row">
   {% for ts, data in board.items() %}
  {% for lane, rows in data.lanes.items() %}

    {# --- Per-lane nagłówek: bezpiecznie pobierz wartości z data.headers[lane] --- #}
    {% set _hdrs = data.headers if data.headers is defined and data.headers else {} %}
    {% set _hdr  = _hdrs.get(lane, {}) %}

    {# Klucze zgodne z loads.py: trailer / status / time_slot #}
    {% set trailer    = (_hdr.get('trailer')    or data.trailer_text or '00000000') %}
    {% set cur_status = (_hdr.get('status')     or 'PL') %}
    {% set cur_time   = (_hdr.get('time_slot')  or (ts if ':' in ts else '17:00')) %}

    {# Jeśli masz gdzieś date/ship_date – użyj; w przeciwnym razie zostaw puste #}
    {% set cur_date   = (data.ship_date or '') %}

    {# --- Zbuduj mapę rekordów DB po AREA (żeby łatwo łączyć wiersze) --- #}
    {% set by_area = namespace(d={}) %}
    {% if rows %}
      {% for r in rows %}
        {% if r.area %}
          {% set _ = by_area.d.update({ r.area: r }) %}
        {% endif %}
      {% endfor %}
    {% endif %}
        <div class="lt-lane {% if lane == 'L01' %}lt-lane--opis{% endif %}">
          <div class="lt-card shadow-soft">

            <!-- Nagłówek karty – układ siatką -->
            <div class="lt-card-header">
              <form class="m-0" method="post" action="{{ url_for('loads.update_header') }}">
                <!-- numer L01/L02/L03 w prawym górnym rogu -->
                <span class="lt-lane-pill">{{ lane }}</span>

                <!-- siatka: 1 rząd (TRAILER | STATUS), 2 rząd (DATA | CZAS) -->
                <div class="lt-hdr-grid">
                  <div class="lt-hdr-field">
                    <div class="lt-hdr-label">TRAILER:</div>
                    <input class="form-control lt-input-pill trailer-strong"
                           name="trailer_no"
                           value="{{ trailer }}"
                           placeholder="np. 88888888" inputmode="numeric">
                  </div>

                  <div class="lt-hdr-field">
                    <div class="lt-hdr-label">STATUS:</div>
                    <div class="lt-pill w-30">
                      <select class="lt-select" name="status" id="hdr-status-{{ ts }}-{{ lane }}">
                        <option value="PL" {{ 'selected' if cur_status=='PL' else '' }}>Planned</option>
                        <option value="PA" {{ 'selected' if cur_status=='PA' else '' }}>Picking Active</option>
                        <option value="LO" {{ 'selected' if cur_status=='LO' else '' }}>Loaded</option>
                      </select>
                      <span class="lt-caret"></span>
                    </div>
                  </div>

                  <div class="lt-hdr-field">
                    <div class="lt-hdr-label">DATA:</div>
                    <input class="form-control lt-input-pill"
                           type="date" name="date"
                           value="{{ cur_date }}">
                  </div>

                  <div class="lt-hdr-field">
                    <div class="lt-hdr-label">CZAS:</div>
                    <input class="form-control lt-input-pill"
                           type="time" name="time_slot"
                           value="{{ cur_time }}">
                  </div>
                </div>

                <!-- hiddeny, żeby zapis był per (ts,lane) -->
                <input type="hidden" name="lane" value="{{ lane }}">
                <input type="hidden" name="orig_time_slot" value="{{ ts }}">

              </form>
            </div>

            <!-- Tabela -->
            <div class="lt-table-wrap">
              <table class="lt-table">
                {% if lane == 'L01' %}
                  <colgroup>
                    <col style="width:22%">  <!-- OPIS -->
                    <col style="width:14%">  <!-- AREA -->
                    <col style="width:16%">  <!-- SEQ -->
                    <col class="do-zrobienia" style="width:1%">   <!-- DO ZROBIENIA -->
                    <col class="zrobione"   style="width:1%">   <!-- ZROBIONE -->
                    <col style="width:18%">  <!-- ZAINFEKOWANE -->
                    <col style="width:26%">  <!-- PICKER -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>OPIS</th>
                      <th>AREA</th>
                      <th>SEQ</th>
                      <th>DO ZROBIENIA</th>
                      <th>ZROBIONE</th>
                      <th>ZAINFEKOWANE</th>
                      <th>PICKER</th>
                    </tr>
                  </thead>
                {% else %}
                  <colgroup>
                    <col style="width:14%">  <!-- AREA -->
                    <col style="width:16%">  <!-- SEQ -->
                    <col class="do-zrobienia" style="width:1%">   <!-- DO ZROBIENIA -->
                    <col class="zrobione"   style="width:1%">   <!-- ZROBIONE -->
                    <col style="width:18%">  <!-- ZAINFEKOWANE -->
                    <col style="width:26%">  <!-- PICKER -->
                  </colgroup>
                  <thead>
                    <tr>
                      <th>AREA</th>
                      <th>SEQ</th>
                      <th>DO ZROBIENIA</th>
                      <th>ZROBIONE</th>
                      <th>ZAINFEKOWANE</th>
                      <th>PICKER</th>
                    </tr>
                  </thead>
                {% endif %}

                <tbody>
                  {# MERGE: zawsze 24 wiersze; dla każdego AREA bierzemy rekord z DB (jeśli jest), inaczej puste #}
                  {% for opis, a, s in default_area_seq %}
                    {% set r = by_area.d.get(a) %}
                    {% set fid = r and ('row-' ~ r.id) %}
                    <tr>
                      {% if lane == 'L01' %}
                        <td>{{ opis }}</td>
                      {% endif %}

                      <td>{{ a }}</td>
                      <td class="seq-col">{{ s }}</td>

                      {% if r %}
                        <td><input name="planned" form="{{ fid }}" class="lt-input lt-cell narrow" value="{{ r.planned or '' }}"></td>
                        <td><input name="done"    form="{{ fid }}" class="lt-input lt-cell narrow" value="{{ r.done or '' }}"></td>
                        <td><input name="lo_code" form="{{ fid }}" class="lt-input lt-cell" value="{{ r.lo_code or '' }}"></td>
                        <td>
                          <div class="lt-actions">
                            <input name="picker" form="{{ fid }}" class="lt-input lt-cell" value="{{ r.picker or '' }}" style="width:120px;">
                            <form id="{{ fid }}" method="post" action="{{ url_for('loads.edit_load', load_id=r.id) }}">
                              <select name="status" class="d-none">
                                <option value="PL" {% if r.status=='PL' %}selected{% endif %}>PL</option>
                                <option value="PA" {% if r.status=='PA' %}selected{% endif %}>PA</option>
                                <option value="LO" {% if r.status=='LO' %}selected{% endif %}>LO</option>
                              </select>
                            </form>
                          </div>
                        </td>
                     {% else %}
  {# --- NOWOŚĆ: ukryty formularz CREATE dla pustego wiersza --- #}
  {% set cid = 'create-' ~ ts ~ '-' ~ lane ~ '-' ~ a %}
  <form id="{{ cid }}" method="post" action="{{ url_for('loads.create_load') }}" class="d-none">
    <input type="hidden" name="time_slot"  value="{{ cur_time }}">
    <input type="hidden" name="lane"       value="{{ lane }}">
    <input type="hidden" name="area"       value="{{ a }}">
    <input type="hidden" name="status"     value="{{ cur_status }}">
    <input type="hidden" name="trailer_no" value="{{ trailer }}">
    <input type="hidden" name="ship_date"  value="{{ cur_date }}">
    {# opcjonalnie: jeśli chcesz jednak trzymać seq-numerek – zostaw puste / None #}
    <input type="hidden" name="seq"        value="">
  </form>

  <td><input name="planned" form="{{ cid }}" class="lt-input lt-cell narrow" placeholder=""></td>
  <td><input name="done"    form="{{ cid }}" class="lt-input lt-cell narrow" placeholder=""></td>
  <td><input name="lo_code" form="{{ cid }}" class="lt-input lt-cell"        placeholder=""></td>
  <td>
    <div class="lt-actions">
      <input name="picker" form="{{ cid }}" class="lt-input lt-cell" style="width:120px;" placeholder="">
      <span class="lt-actions-spacer"></span>
    </div>
  </td>
{% endif %}


                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>

      {% endfor %}
    {% endfor %}

  </div>
</div>

{% endblock %}